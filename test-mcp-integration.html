<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teste de IntegraÃ§Ã£o MCP - Zenith Tasks</title>
    <style>
        body { 
            font-family: system-ui; 
            padding: 20px; 
            background: #0a0a0a; 
            color: #e0e0e0;
        }
        .container { max-width: 800px; margin: 0 auto; }
        button { 
            padding: 10px 20px; 
            background: #3b82f6; 
            color: white; 
            border: none; 
            border-radius: 6px; 
            cursor: pointer; 
            margin: 5px;
        }
        button:hover { background: #2563eb; }
        button:disabled { 
            background: #374151; 
            cursor: not-allowed; 
        }
        .result { 
            margin: 10px 0; 
            padding: 15px; 
            background: #1f2937; 
            border-radius: 8px; 
            border-left: 3px solid #3b82f6;
        }
        .error { border-left-color: #ef4444; }
        .success { border-left-color: #10b981; }
        pre { 
            background: #111827; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto;
        }
        h2 { color: #60a5fa; margin-top: 30px; }
        .test-section { 
            background: #111827; 
            padding: 20px; 
            border-radius: 8px; 
            margin: 20px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸ§ª Teste de IntegraÃ§Ã£o MCP - Zenith Tasks</h1>
        
        <div class="test-section">
            <h2>1. Servidor de Teste Local</h2>
            <button onclick="listServers()">Listar Servidores</button>
            <button onclick="addTestServer()">Adicionar Servidor de Teste</button>
            <button onclick="listTools()">Listar Tools</button>
            <button onclick="testCalculator()">Testar Calculadora</button>
            <button onclick="testEcho()">Testar Echo</button>
            <div id="result-1"></div>
        </div>

        <div class="test-section">
            <h2>2. Teste de IntegraÃ§Ã£o Completa</h2>
            <button onclick="runFullTest()">Executar Teste Completo</button>
            <div id="result-2"></div>
        </div>

        <div class="test-section">
            <h2>3. PersistÃªncia de Dados</h2>
            <button onclick="testPersistence()">Testar PersistÃªncia</button>
            <div id="result-3"></div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:3457/api/mcp';
        
        function showResult(elementId, content, type = 'info') {
            const el = document.getElementById(elementId);
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
            el.innerHTML = `<div class="result ${className}">
                <strong>${type.toUpperCase()}:</strong>
                <pre>${typeof content === 'object' ? JSON.stringify(content, null, 2) : content}</pre>
            </div>` + el.innerHTML;
        }

        async function listServers() {
            try {
                const res = await fetch(`${API_BASE}/servers`);
                const data = await res.json();
                showResult('result-1', data, 'success');
            } catch (e) {
                showResult('result-1', e.message, 'error');
            }
        }

        async function addTestServer() {
            try {
                const res = await fetch(`${API_BASE}/servers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        id: 'local-test',
                        name: 'Local MCP Test Server',
                        baseUrl: 'http://localhost:8765',
                        toolsPath: '/tools'
                    })
                });
                const data = await res.json();
                showResult('result-1', 'Servidor adicionado: ' + data.saved.name, 'success');
            } catch (e) {
                showResult('result-1', e.message, 'error');
            }
        }

        async function listTools() {
            try {
                const res = await fetch(`${API_BASE}/servers/local-test/tools`);
                const data = await res.json();
                showResult('result-1', data, 'success');
            } catch (e) {
                showResult('result-1', e.message, 'error');
            }
        }

        async function testCalculator() {
            try {
                const res = await fetch(`${API_BASE}/servers/local-test/call`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'calculator',
                        arguments: {
                            operation: 'add',
                            a: 25,
                            b: 17
                        }
                    })
                });
                const data = await res.json();
                showResult('result-1', `25 + 17 = ${data.result}`, 'success');
            } catch (e) {
                showResult('result-1', e.message, 'error');
            }
        }

        async function testEcho() {
            try {
                const res = await fetch(`${API_BASE}/servers/local-test/call`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: 'test-tool',
                        arguments: {
                            message: 'MCP Integration Working!'
                        }
                    })
                });
                const data = await res.json();
                showResult('result-1', data, 'success');
            } catch (e) {
                showResult('result-1', e.message, 'error');
            }
        }

        async function runFullTest() {
            const tests = [
                { name: 'Adicionar servidor', fn: addTestServer },
                { name: 'Listar servidores', fn: listServers },
                { name: 'Listar tools', fn: listTools },
                { name: 'Testar calculadora', fn: testCalculator },
                { name: 'Testar echo', fn: testEcho }
            ];

            showResult('result-2', 'Iniciando teste completo...', 'info');
            
            for (const test of tests) {
                showResult('result-2', `Executando: ${test.name}`, 'info');
                await test.fn();
                await new Promise(r => setTimeout(r, 500));
            }
            
            showResult('result-2', 'Teste completo finalizado!', 'success');
        }

        async function testPersistence() {
            showResult('result-3', 'Testando persistÃªncia...', 'info');
            
            // Adicionar servidor com ID Ãºnico
            const uniqueId = 'test-' + Date.now();
            await fetch(`${API_BASE}/servers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    id: uniqueId,
                    name: 'Persistence Test',
                    baseUrl: 'http://localhost:8765'
                })
            });
            
            // Verificar se foi salvo
            const res = await fetch(`${API_BASE}/servers`);
            const servers = await res.json();
            const found = servers.find(s => s.id === uniqueId);
            
            if (found) {
                showResult('result-3', `Servidor ${uniqueId} persistido com sucesso!`, 'success');
                
                // Remover servidor de teste
                await fetch(`${API_BASE}/servers/${uniqueId}`, { method: 'DELETE' });
                showResult('result-3', 'Servidor de teste removido', 'info');
            } else {
                showResult('result-3', 'Falha na persistÃªncia', 'error');
            }
        }
    </script>
</body>
</html>